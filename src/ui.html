
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Live Blog (Simulated)</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background: #0b0c0c; color: #fff; }
      header { position: sticky; top: 0; backdrop-filter: blur(6px); background: rgba(0,0,0,0.5); padding: 12px 16px; border-bottom: 1px solid #333; }
      .live { display: inline-flex; align-items: center; gap: 8px; font-weight: 700; }
      .dot { width: 10px; height: 10px; border-radius: 50%; background: #ff4d4f; box-shadow: 0 0 0 0 rgba(255,77,79, 0.7); animation: pulse 1.4s infinite; }
      @keyframes pulse { 0%{box-shadow:0 0 0 0 rgba(255,77,79,.7);} 70%{box-shadow:0 0 0 8px rgba(255,77,79,0);} 100%{box-shadow:0 0 0 0 rgba(255,77,79,0);} }
      main { max-width: 860px; margin: 24px auto; padding: 0 16px 80px; }
      .card { background: #111; border: 1px solid #333; border-radius: 16px; padding: 16px 18px; margin: 14px 0; box-shadow: 0 6px 20px rgba(0,0,0,.2); }
      .meta { font-size: 12px; color: #aaa; margin-bottom: 6px; }
      h3 { margin: 8px 0 8px; font-size: 18px; }
      ul { margin: 8px 0 0 18px; }
      .small { font-size: 12px; color: #bbb; }
      .empty { opacity: .7; text-align: center; padding: 40px 0; }
    </style>
  </head>
  <body>
    <header>
      <div class="live"><span class="dot"></span> Live blog (simulated)</div>
    </header>
    <main>
      <div style="margin: 18px 0 24px 0;">
        <input type="file" id="audioFile" accept="audio/*" />
        <button id="playBtn" disabled>Play & Stream</button>
      </div>
      <audio id="audio" controls style="width:100%; display:none;"></audio>
      <div id="list" class="empty">Waiting for chunks…</div>
    </main>
    <script>
      const list = document.getElementById('list');
      const fmt = s => new Date(s*1000).toISOString().substring(14,19);
      const es = new EventSource('/stream');
      const add = c => {
        if (list.classList.contains('empty')) list.classList.remove('empty'), list.innerHTML='';
        const el = document.createElement('article');
        el.className = 'card';
        el.innerHTML = `
          <div class="meta">${fmt(c.time_start)}–${fmt(c.time_end)} • conf ${(c.confidence*100).toFixed(0)}%</div>
          <h3>${escapeHtml(c.headline)}</h3>
          <ul>${c.bullets.map(b=>`<li>${escapeHtml(b)}</li>`).join('')}</ul>
          ${c.quotes?.length? `<div class="small"><strong>Quotes:</strong> ${c.quotes.map(q=>`“${escapeHtml(q)}”`).join(' · ')}</div>`:''}
        `;
        list.prepend(el);
      };
      es.addEventListener('chunk', ev => add(JSON.parse(ev.data)));
      es.addEventListener('eof', () => {
        const done = document.createElement('div');
        done.className = 'small';
        done.textContent = 'End of file';
        list.prepend(done);
      });
      function escapeHtml(s){return s.replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[c]))}

      // --- Audio file selection and streaming ---
      const audioFile = document.getElementById('audioFile');
      const playBtn = document.getElementById('playBtn');
      const audio = document.getElementById('audio');
      let fileBuffer = null;
      let ws = null;

      audioFile.addEventListener('change', e => {
        const file = e.target.files[0];
        if (file) {
          const url = URL.createObjectURL(file);
          audio.src = url;
          audio.style.display = '';
          playBtn.disabled = false;
          fileBuffer = file;
        } else {
          playBtn.disabled = true;
          audio.style.display = 'none';
          fileBuffer = null;
        }
      });

      playBtn.addEventListener('click', async () => {
        if (!fileBuffer) return;
        playBtn.disabled = true;
        const wsProtocol = location.protocol === 'https:' ? 'wss' : 'ws';
        ws = new WebSocket(`${wsProtocol}://${location.host}/audio-stream`);
        ws.binaryType = 'arraybuffer';
        let chunkSize = 32 * 1024; // 32KB
        let file = fileBuffer;
        let offset = 0;
        let lastSentTime = 0;
        let sending = false;

        function sendNextChunk() {
          if (!ws || ws.readyState !== 1 || audio.paused) return;
          // Calculate how much should have been sent based on playback
          const playedBytes = Math.floor((audio.currentTime / audio.duration) * file.size);
          while (offset + chunkSize <= playedBytes) {
            const chunk = file.slice(offset, offset + chunkSize);
            chunk.arrayBuffer().then(arrayBuffer => {
              ws.send(arrayBuffer);
            });
            offset += chunkSize;
          }
        }

        ws.onopen = () => {
          audio.currentTime = 0;
          offset = 0;
          audio.play();
          sending = true;
        };

        ws.onclose = () => {
          playBtn.disabled = false;
          sending = false;
        };

        audio.addEventListener('timeupdate', sendNextChunk);
        audio.addEventListener('pause', () => { sending = false; });
        audio.addEventListener('ended', () => {
          // Send any remaining data
          while (offset < file.size && ws && ws.readyState === 1) {
            const chunk = file.slice(offset, offset + chunkSize);
            chunk.arrayBuffer().then(arrayBuffer => {
              ws.send(arrayBuffer);
            });
            offset += chunkSize;
          }
          if (ws && ws.readyState === 1) ws.close();
        });
      });
    </script>
  </body>
</html>